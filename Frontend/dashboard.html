<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SafeHome – Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg">
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-circle small">SH</div>
        <div>
          <h1>SafeHome</h1>
          <p>Smart dashboard</p>
        </div>
      </div>

      <nav class="sidebar-nav">
        <a href="#" class="nav-link active">
          <span>Dashboard</span>
        </a>
        <a href="#" class="nav-link">
          <span>Edifícios</span>
        </a>
        <a href="#" class="nav-link">
          <span>Sensores</span>
        </a>
        <a href="#" class="nav-link">
          <span>Alertas / Incidentes</span>
        </a>
      </nav>

      <button id="btn-logout" class="btn-ghost">
        Terminar sessão
      </button>
    </aside>

    <!-- Conteúdo principal -->
    <main class="main">
      <!-- Topbar -->
      <header class="topbar">
        <div>
          <h2>Dashboard</h2>
          <p id="welcome-text">Bem-vindo(a)</p>
        </div>
        <div class="topbar-right">
          <span id="user-role-badge" class="badge">Utilizador</span>
          <button id="btn-profile" class="btn-secondary">Perfil</button>
        </div>
      </header>

      <!-- Cards de resumo -->
      <section class="cards-grid">
        <article class="card stat-card">
          <h3>Edifícios</h3>
          <p id="stat-buildings" class="stat-number">–</p>
          <p class="stat-label">Total registado</p>
        </article>

        <article class="card stat-card">
          <h3>Sensores</h3>
          <p id="stat-sensors" class="stat-number">–</p>
          <p class="stat-label">Total registado</p>
        </article>

        <article class="card stat-card">
          <h3>Alertas</h3>
          <p id="stat-alerts" class="stat-number">–</p>
          <p class="stat-label">Ativos</p>
        </article>

        <article class="card stat-card">
          <h3>Incidentes</h3>
          <p id="stat-incidents" class="stat-number">–</p>
          <p class="stat-label">Ativos / Reportados</p>
        </article>
      </section>

      <!-- Tabela de edifícios -->
      <section class="card panel">
        <div class="panel-header">
          <h3>Lista de edifícios</h3>
          <button id="reload-buildings" class="btn-secondary">
            Recarregar
          </button>
        </div>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Morada</th>
                <th>Risco</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="buildings-table-body">
              <tr>
                <td colspan="5">A carregar...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Gestão de sensores -->
      <section class="card panel">
        <div class="panel-header">
          <h3>Gestão de sensores</h3>
          <div class="panel-actions">
            <button id="reload-sensors" class="btn-secondary">
              Recarregar
            </button>
          </div>
        </div>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Tipo</th>
                <th>Edifício</th>
                <th>Estado</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="sensors-table-body">
              <tr>
                <td colspan="6">A carregar...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Leituras de sensores -->
      <section class="card panel">
        <div class="panel-header">
          <h3>Últimas leituras de sensores</h3>
          <button id="reload-readings" class="btn-secondary">
            Recarregar
          </button>
        </div>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Data / Hora</th>
                <th>Sensor</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="readings-table-body">
              <tr>
                <td colspan="3">A carregar...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Incidentes -->
      <section class="card panel">
        <div class="panel-header">
          <h3>Incidentes recentes</h3>
          <button id="reload-incidents" class="btn-secondary">
            Recarregar
          </button>
        </div>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Início</th>
                <th>Tipo</th>
                <th>Severidade</th>
                <th>Estado</th>
                <th>Edifício</th>
              </tr>
            </thead>
            <tbody id="incidents-table-body">
              <tr>
                <td colspan="5">A carregar...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <div id="profile-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-content">
      <button id="close-profile" class="modal-close" aria-label="Fechar">×</button>
      <h3>Perfil do utilizador</h3>
      <p>Consulta os teus dados e altera a palavra-passe.</p>

      <div class="profile-info">
        <div>
          <small>Utilizador</small>
          <span id="profile-username">–</span>
        </div>
        <div>
          <small>Perfil</small>
          <span id="profile-role">–</span>
        </div>
      </div>

      <form id="form-change-password" class="login-form">
        <div class="field">
          <label for="current-password">Password atual</label>
          <input type="password" id="current-password" required minlength="4" />
        </div>
        <div class="field">
          <label for="new-password">Nova password</label>
          <input type="password" id="new-password" required minlength="4" />
        </div>
        <div class="form-actions">
          <button type="submit" class="btn-primary" style="width: auto; min-width: 140px;">
            Atualizar password
          </button>
          <p id="password-status" class="status-message" aria-live="polite"></p>
        </div>
      </form>
    </div>
  </div>

  <script>
    // =====================================
    // CONFIG – AJUSTA PARA AZURE DEPOIS
    // =====================================
    const API_BASE_URL = "https://localhost:7152"; // quando subires a API muda aqui
    const TOKEN_KEY = "safehome_token";
    const USERNAME_KEY = "safehome_username";

    let buildingsCache = [];
    let sensorsCache = [];
    let currentUser = { username: null, role: null };

    function getToken() {
      return localStorage.getItem(TOKEN_KEY);
    }

    function ensureAuthenticated() {
      const token = getToken();
      if (!token) {
        window.location.href = "login.html";
        return false;
      }
      return true;
    }

    function escapeHtml(str) {
      if (str == null) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    async function apiFetch(path, options = {}) {
      const token = getToken();
      if (!token) {
        throw new Error("Sem token. Inicia sessão novamente.");
      }

      const headers = {
        Authorization: "Bearer " + token,
        ...(options.headers || {}),
      };

      if (options.body && !headers["Content-Type"]) {
        headers["Content-Type"] = "application/json";
      }

      const response = await fetch(API_BASE_URL + path, {
        ...options,
        headers,
      });

      if (!response.ok) {
        const text = await response.text().catch(() => "");
        throw new Error(
          `Erro ${response.status}` + (text ? `: ${text}` : "")
        );
      }

      const contentType = response.headers.get("content-type") || "";
      if (contentType.includes("application/json")) {
        return response.json();
      }
      return response.text();
    }

    function isAdmin() {
      return (currentUser.role || "").toLowerCase() === "admin";
    }

    function setWelcomeMessage() {
      const welcome = document.getElementById("welcome-text");
      const username = currentUser.username || localStorage.getItem(USERNAME_KEY) || "Utilizador";
      welcome.textContent = `Bem-vindo(a), ${username}`;
    }

    function updateRoleBadge() {
      const badge = document.getElementById("user-role-badge");
      if (!badge) return;
      badge.textContent = currentUser.role || "Utilizador";
    }

    async function loadCurrentUser() {
      try {
        const user = await apiFetch("/api/Auth/Me");
        currentUser = user || {};
        if (currentUser.username) {
          localStorage.setItem(USERNAME_KEY, currentUser.username);
        }
        setWelcomeMessage();
        updateRoleBadge();
        document.getElementById("profile-username").textContent = currentUser.username || "-";
        document.getElementById("profile-role").textContent = currentUser.role || "-";
      } catch (err) {
        console.warn("Erro ao obter dados do utilizador:", err);
        setWelcomeMessage();
      }
    }

    // ----------------------------
    // Edifícios
    // GET /api/Buildings
    // ----------------------------
    async function loadBuildings() {
      const tbody = document.getElementById("buildings-table-body");
      tbody.innerHTML = `
        <tr>
          <td colspan="5">A carregar...</td>
        </tr>
      `;

      try {
        const buildings = await apiFetch("/api/Buildings");
        buildingsCache = Array.isArray(buildings) ? buildings : [];

        if (!buildingsCache.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5">Nenhum edifício encontrado.</td>
            </tr>
          `;
          document.getElementById("stat-buildings").textContent = "0";
          return;
        }

        document.getElementById("stat-buildings").textContent =
          buildingsCache.length;

        const rowsHtml = buildingsCache
          .map((b) => {
            const id = b.id;
            const name = b.name || `Edifício #${id}`;
            const address = b.address || "-";
            const risk = b.riskType || "-";
            const actions = isAdmin()
              ? `<div class="table-actions"><button class="btn-danger" data-action="delete-building" data-id="${id}">Remover</button></div>`
              : `<span class="muted">Requer perfil Admin</span>`;

            return `
              <tr>
                <td>${escapeHtml(id)}</td>
                <td>${escapeHtml(name)}</td>
                <td>${escapeHtml(address)}</td>
                <td>${escapeHtml(risk)}</td>
                <td>${actions}</td>
              </tr>
            `;
          })
          .join("");

        tbody.innerHTML = rowsHtml;
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `
          <tr>
            <td colspan="5">Erro ao carregar edifícios: ${escapeHtml(
              err.message
            )}</td>
          </tr>
        `;
        document.getElementById("stat-buildings").textContent = "–";
      }
    }

    async function deleteBuilding(id) {
      if (!isAdmin()) {
        alert("Apenas administradores podem remover edifícios.");
        return;
      }
      if (!confirm("Tens a certeza que queres remover este edifício e dados associados?")) return;

      try {
        await apiFetch(`/api/Buildings/${id}`, { method: "DELETE" });
        await loadStats();
      } catch (err) {
        alert(err.message || "Erro ao remover edifício.");
      }
    }

    // ----------------------------
    // Sensores
    // ----------------------------
    async function loadSensors() {
      const tbody = document.getElementById("sensors-table-body");
      tbody.innerHTML = `
        <tr>
          <td colspan="6">A carregar...</td>
        </tr>
      `;

      try {
        const sensors = await apiFetch("/api/Sensors");
        sensorsCache = Array.isArray(sensors) ? sensors : [];

        if (!sensorsCache.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6">Nenhum sensor encontrado.</td>
            </tr>
          `;
          document.getElementById("stat-sensors").textContent = "0";
          return;
        }

        document.getElementById("stat-sensors").textContent = sensorsCache.length;

        const rowsHtml = sensorsCache
          .map((s) => {
            const buildingName =
              (buildingsCache.find((b) => b.id === s.buildingId) || {}).name ||
              (s.buildingId != null ? `Edifício #${s.buildingId}` : "-");
            const statusLabel = s.isActive ? "Ativo" : "Inativo";
            const actions = isAdmin()
              ? `<div class="table-actions"><button class="btn-danger" data-action="delete-sensor" data-id="${s.id}">Remover</button></div>`
              : `<span class="muted">Requer perfil Admin</span>`;

            return `
              <tr>
                <td>${escapeHtml(s.id)}</td>
                <td>${escapeHtml(s.name || `Sensor #${s.id}`)}</td>
                <td>${escapeHtml(s.type || "-")}</td>
                <td>${escapeHtml(buildingName)}</td>
                <td><span class="status-chip ${s.isActive ? "" : "off"}">${escapeHtml(statusLabel)}</span></td>
                <td>${actions}</td>
              </tr>
            `;
          })
          .join("");

        tbody.innerHTML = rowsHtml;
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `
          <tr>
            <td colspan="6">Erro ao carregar sensores: ${escapeHtml(
              err.message
            )}</td>
          </tr>
        `;
        document.getElementById("stat-sensors").textContent = "–";
      }
    }

    async function deleteSensor(id) {
      if (!isAdmin()) {
        alert("Apenas administradores podem remover sensores.");
        return;
      }
      if (!confirm("Tens a certeza que queres remover este sensor e dados associados?")) return;

      try {
        await apiFetch(`/api/Sensors/${id}`, { method: "DELETE" });
        await loadStats();
      } catch (err) {
        alert(err.message || "Erro ao remover sensor.");
      }
    }

    // ----------------------------
    // Stats: alertas / incidentes
    // ----------------------------
    async function loadAlertsStats() {
      try {
        const alerts = await apiFetch("/api/Alerts");
        const items = Array.isArray(alerts) ? alerts : [];
        const active = items.filter((a) => a.isResolved === false).length;
        document.getElementById("stat-alerts").textContent =
          active || items.length || "0";
      } catch (err) {
        console.warn("Erro ao carregar alertas:", err);
        document.getElementById("stat-alerts").textContent = "–";
      }
    }

    async function loadIncidentsStats() {
      try {
        const incidents = await apiFetch("/api/Incidents");
        const items = Array.isArray(incidents) ? incidents : [];
        const active = items.filter(
          (i) =>
            (i.status || "").toString().toLowerCase() !== "resolved" ||
            i.endedAt == null
        ).length;
        document.getElementById("stat-incidents").textContent =
          active || items.length || "0";
      } catch (err) {
        console.warn("Erro ao carregar incidentes:", err);
        document.getElementById("stat-incidents").textContent = "–";
      }
    }

    // ----------------------------
    // Leituras de sensores
    // GET /api/SensorReadings
    // ----------------------------
    async function loadLatestReadings(limit = 10) {
      const tbody = document.getElementById("readings-table-body");
      tbody.innerHTML = `
        <tr>
          <td colspan="3">A carregar...</td>
        </tr>
      `;

      try {
        const readings = await apiFetch("/api/SensorReadings");
        const list = Array.isArray(readings) ? readings : [];

        if (!list.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="3">Nenhuma leitura encontrada.</td>
            </tr>
          `;
          return;
        }

        const sorted = list
          .slice()
          .sort(
            (a, b) =>
              new Date(b.timestamp || 0) - new Date(a.timestamp || 0)
          )
          .slice(0, limit);

        const rowsHtml = sorted
          .map((r) => {
            const ts = r.timestamp
              ? new Date(r.timestamp).toLocaleString("pt-PT")
              : "-";

            const sensorLabel =
              (r.sensor &&
                (r.sensor.name || `Sensor #${r.sensor.id}`)) ||
              (r.sensorId != null
                ? `Sensor #${r.sensorId}`
                : "Sensor");

            const value =
              r.value != null ? r.value.toString() : "-";

            return `
              <tr>
                <td>${escapeHtml(ts)}</td>
                <td>${escapeHtml(sensorLabel)}</td>
                <td>${escapeHtml(value)}</td>
              </tr>
            `;
          })
          .join("");

        tbody.innerHTML = rowsHtml;
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `
          <tr>
            <td colspan="3">Erro ao carregar leituras: ${escapeHtml(
              err.message
            )}</td>
          </tr>
        `;
      }
    }

    // ----------------------------
    // Incidentes
    // GET /api/Incidents
    // ----------------------------
    async function loadLatestIncidents(limit = 10) {
      const tbody = document.getElementById("incidents-table-body");
      tbody.innerHTML = `
        <tr>
          <td colspan="5">A carregar...</td>
        </tr>
      `;

      try {
        const incidents = await apiFetch("/api/Incidents");
        const list = Array.isArray(incidents) ? incidents : [];

        if (!list.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5">Nenhum incidente encontrado.</td>
            </tr>
          `;
          return;
        }

        const sorted = list
          .slice()
          .sort(
            (a, b) =>
              new Date(b.startedAt || 0) - new Date(a.startedAt || 0)
          )
          .reverse()
          .slice(0, limit);

        const rowsHtml = sorted
          .map((i) => {
            const start = i.startedAt
              ? new Date(i.startedAt).toLocaleString("pt-PT")
              : "-";
            const type = i.type || "-";
            const severity = i.severity || "-";
            const status = i.status || "-";

            const buildingName =
              (i.building && i.building.name) ||
              (buildingsCache.find((b) => b.id === i.buildingId) || {})
                .name ||
              (i.buildingId != null
                ? `Edifício #${i.buildingId}`
                : "-");

            return `
              <tr>
                <td>${escapeHtml(start)}</td>
                <td>${escapeHtml(type)}</td>
                <td>${escapeHtml(severity)}</td>
                <td>${escapeHtml(status)}</td>
                <td>${escapeHtml(buildingName)}</td>
              </tr>
            `;
          })
          .join("");

        tbody.innerHTML = rowsHtml;
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `
          <tr>
            <td colspan="5">Erro ao carregar incidentes: ${escapeHtml(
              err.message
            )}</td>
          </tr>
        `;
      }
    }

    // ----------------------------
    // Perfil do utilizador
    // ----------------------------
    function openProfileModal() {
      document.getElementById("profile-username").textContent = currentUser.username || "-";
      document.getElementById("profile-role").textContent = currentUser.role || "-";
      document.getElementById("password-status").textContent = "";
      document.getElementById("current-password").value = "";
      document.getElementById("new-password").value = "";
      document.getElementById("profile-modal").classList.remove("hidden");
    }

    function closeProfileModal() {
      document.getElementById("profile-modal").classList.add("hidden");
    }

    async function submitPasswordChange(event) {
      event.preventDefault();
      const currentPassword = document.getElementById("current-password").value;
      const newPassword = document.getElementById("new-password").value;
      const status = document.getElementById("password-status");
      status.textContent = "A atualizar...";
      status.classList.remove("error", "success");

      try {
        await apiFetch("/api/Auth/ChangePassword", {
          method: "POST",
          body: JSON.stringify({ currentPassword, newPassword }),
        });
        status.textContent = "Password atualizada com sucesso.";
        status.classList.add("success");
        document.getElementById("form-change-password").reset();
      } catch (err) {
        status.textContent = err.message || "Erro ao atualizar password.";
        status.classList.add("error");
      }
    }

    // ----------------------------
    // Carregar tudo
    // ----------------------------
    async function loadStats() {
      await loadBuildings();        // precisa disto para o cache de edifícios
      await loadSensors();
      await loadAlertsStats();
      await loadIncidentsStats();
      await loadLatestReadings();
      await loadLatestIncidents();
    }

    // ----------------------------
    // Inicialização
    // ----------------------------
    document.addEventListener("DOMContentLoaded", async () => {
      if (!ensureAuthenticated()) return;

      await loadCurrentUser();
      await loadStats();

      document
        .getElementById("reload-buildings")
        .addEventListener("click", () => loadBuildings());

      document
        .getElementById("reload-sensors")
        .addEventListener("click", () => loadSensors());

      document
        .getElementById("reload-readings")
        .addEventListener("click", () => loadLatestReadings());

      document
        .getElementById("reload-incidents")
        .addEventListener("click", () => loadLatestIncidents());

      document
        .getElementById("btn-logout")
        .addEventListener("click", () => {
          localStorage.removeItem(TOKEN_KEY);
          localStorage.removeItem(USERNAME_KEY);
          window.location.href = "login.html";
        });

      document
        .getElementById("btn-profile")
        .addEventListener("click", () => openProfileModal());

      document
        .getElementById("close-profile")
        .addEventListener("click", () => closeProfileModal());

      document
        .getElementById("profile-modal")
        .addEventListener("click", (event) => {
          if (event.target.id === "profile-modal") closeProfileModal();
        });

      document
        .getElementById("form-change-password")
        .addEventListener("submit", submitPasswordChange);

      document
        .getElementById("buildings-table-body")
        .addEventListener("click", (event) => {
          const btn = event.target.closest("button[data-action='delete-building']");
          if (btn) {
            const id = Number(btn.dataset.id);
            deleteBuilding(id);
          }
        });

      document
        .getElementById("sensors-table-body")
        .addEventListener("click", (event) => {
          const btn = event.target.closest("button[data-action='delete-sensor']");
          if (btn) {
            const id = Number(btn.dataset.id);
            deleteSensor(id);
          }
        });
    });
  </script>
</body>
</html>
