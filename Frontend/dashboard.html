<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SafeHome – Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body class="bg">
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-circle small">SH</div>
        <div>
          <h1>SafeHome</h1>
          <p>Smart dashboard</p>
        </div>
      </div>

      <nav class="sidebar-nav">
        <a href="#top" class="nav-link active">
          <span>Dashboard</span>
        </a>
        <a href="#buildings" class="nav-link">
          <span>Edifícios</span>
        </a>
        <a href="#sensors" class="nav-link">
          <span>Sensores</span>
        </a>
        <a href="#alerts" class="nav-link">
          <span>Alertas / Incidentes</span>
        </a>
      </nav>

      <button id="btn-logout" class="btn-ghost">
        Terminar sessão
      </button>
    </aside>

    <!-- Conteúdo principal -->
    <main id="top" class="main">
      <!-- Topbar -->
      <header class="topbar">
        <div>
          <h2>Dashboard</h2>
          <p id="welcome-text">Bem-vindo(a)</p>
        </div>
        <div class="topbar-right">
          <span id="role-badge" class="badge">Perfil</span>
        </div>
      </header>

      <div id="global-status" class="banner hidden" role="status" aria-live="polite"></div>

      <!-- Cards de resumo -->
      <section id="summary" class="cards-grid">
        <article class="card stat-card">
          <h3>Edifícios</h3>
          <p id="stat-buildings" class="stat-number">–</p>
          <p class="stat-label">Total registado</p>
        </article>

        <article class="card stat-card">
          <h3>Sensores</h3>
          <p id="stat-sensors" class="stat-number">–</p>
          <p class="stat-label">Total registado</p>
        </article>

        <article class="card stat-card">
          <h3>Alertas</h3>
          <p id="stat-alerts" class="stat-number">–</p>
          <p class="stat-label">Ativos</p>
        </article>

        <article class="card stat-card">
          <h3>Incidentes</h3>
          <p id="stat-incidents" class="stat-number">–</p>
          <p class="stat-label">Ativos / Reportados</p>
        </article>
      </section>

      <!-- Tabela de edifícios -->
      <section id="buildings" class="card panel">
        <div class="panel-header">
          <h3>Lista de edifícios</h3>
          <button id="reload-buildings" class="btn-secondary">
            Recarregar
          </button>
        </div>

        <div id="building-admin-panel" class="admin-panel hidden">
          <h4>Adicionar novo edifício</h4>
          <form id="create-building-form" class="compact-form">
            <div class="form-grid">
              <label class="field">
                <span>Nome</span>
                <input type="text" id="building-name" name="name" required />
              </label>
              <label class="field">
                <span>Morada</span>
                <input type="text" id="building-address" name="address" required />
              </label>
              <label class="field">
                <span>Latitude</span>
                <input type="number" step="0.000001" id="building-latitude" name="latitude" required />
              </label>
              <label class="field">
                <span>Longitude</span>
                <input type="number" step="0.000001" id="building-longitude" name="longitude" required />
              </label>
              <label class="field">
                <span>Tipo de risco</span>
                <input type="text" id="building-risk" name="riskType" placeholder="Ex.: Incêndio" />
              </label>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-primary">Guardar edifício</button>
              <p id="create-building-status" class="status-message"></p>
            </div>
          </form>
        </div>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Morada</th>
                <th>Risco</th>
              </tr>
            </thead>
            <tbody id="buildings-table-body">
              <tr>
                <td colspan="4">A carregar...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Leituras de sensores -->
      <section id="sensors" class="card panel">
        <div class="panel-header">
          <h3>Últimas leituras de sensores</h3>
          <button id="reload-readings" class="btn-secondary">
            Recarregar
          </button>
        </div>

        <div id="sensor-admin-panel" class="admin-panel hidden">
          <h4>Adicionar sensor</h4>
          <form id="create-sensor-form" class="compact-form">
            <div class="form-grid">
              <label class="field">
                <span>Nome</span>
                <input type="text" id="sensor-name" name="name" required />
              </label>
              <label class="field">
                <span>Tipo</span>
                <input type="text" id="sensor-type" name="type" placeholder="Ex.: Smoke" required />
              </label>
              <label class="field">
                <span>ID do edifício</span>
                <input type="number" id="sensor-building-id" name="buildingId" min="1" />
              </label>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-primary">Guardar sensor</button>
              <p id="create-sensor-status" class="status-message"></p>
            </div>
          </form>
        </div>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Data / Hora</th>
                <th>Sensor</th>
                <th>ID Sensor</th>
                <th>ID Edifício</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="readings-table-body">
              <tr>
                <td colspan="5">A carregar...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Alertas -->
      <section id="alerts" class="card panel">
        <div class="panel-header">
          <h3>Alertas recentes</h3>
          <button id="reload-alerts" class="btn-secondary">
            Recarregar
          </button>
        </div>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Data / Hora</th>
                <th>Tipo</th>
                <th>Severidade</th>
                <th>Estado</th>
                <th>Origem</th>
              </tr>
            </thead>
            <tbody id="alerts-table-body">
              <tr>
                <td colspan="5">A carregar...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>


      <!-- Incidentes -->
      <section id="incidents" class="card panel">
        <div class="panel-header">
          <h3>Incidentes recentes</h3>
          <button id="reload-incidents" class="btn-secondary">
            Recarregar
          </button>
        </div>

        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Início</th>
                <th>Tipo</th>
                <th>Severidade</th>
                <th>Estado</th>
                <th>Edifício</th>
              </tr>
            </thead>
            <tbody id="incidents-table-body">
              <tr>
                <td colspan="5">A carregar...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    // =====================================
    // CONFIG – AJUSTA PARA AZURE DEPOIS
    // =====================================
    const API_BASE_URL = "https://safehomeapi-22997-23015-h8dufye2amezh5f4.spaincentral-01.azurewebsites.net"; // quando subires a API muda aqui
    const TOKEN_KEY = "safehome_token";
    const USERNAME_KEY = "safehome_username";
    const ROLE_KEY = "safehome_role";

    let buildingsCache = [];

    function getToken() {
      return localStorage.getItem(TOKEN_KEY);
    }

    function parseJwt(token) {
      try {
        const payloadBase64 = token.split(".")[1].replace(/-/g, "+").replace(/_/g, "/");
        const decoded = atob(payloadBase64);
        return JSON.parse(decoded);
      } catch (err) {
        console.warn("Não foi possível interpretar o token:", err);
        return null;
      }
    }

    function extractRole(payload) {
      if (!payload) return null;
      return (
        payload.role ||
        payload["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"] ||
        null
      );
    }

    function ensureAuthenticated() {
      const token = getToken();
      if (!token) {
        showGlobalMessage("A tua sessão terminou. Faz login novamente.", "error");
        window.location.href = "login.html";
        return false;
      }
      return true;
    }

    function escapeHtml(str) {
      if (str == null) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function redirectToLogin() {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(USERNAME_KEY);
      localStorage.removeItem(ROLE_KEY);
      window.location.href = "login.html";
    }

    function showGlobalMessage(message, type = "info") {
      const banner = document.getElementById("global-status");
      if (!banner) return;

      banner.textContent = message || "";
      banner.classList.remove("error", "success", "hidden");

      if (!message) {
        banner.classList.add("hidden");
        return;
      }

      if (type === "error") banner.classList.add("error");
      if (type === "success") banner.classList.add("success");
    }

    async function apiFetch(path, options = {}) {
      const token = getToken();
      if (!token) {
        throw new Error("Sem token. Inicia sessão novamente.");
      }

      const headers = {
        Authorization: "Bearer " + token,
        ...(options.headers || {}),
      };

      if (options.body && !headers["Content-Type"]) {
        headers["Content-Type"] = "application/json";
      }

      const response = await fetch(API_BASE_URL + path, {
        ...options,
        headers,
      });

      if (response.status === 401 || response.status === 403) {
        showGlobalMessage("Sessão expirada. Volta a iniciar sessão.", "error");
        redirectToLogin();
        return Promise.reject(new Error("Sessão expirada."));
      }

      if (!response.ok) {
        const text = await response.text().catch(() => "");
        throw new Error(
          `Erro ${response.status}` + (text ? `: ${text}` : "")
        );
      }

      const contentType = response.headers.get("content-type") || "";
      if (contentType.includes("application/json")) {
        return response.json();
      }
      return response.text();
    }

    function setWelcomeMessage() {
      const username = localStorage.getItem(USERNAME_KEY) || "Utilizador";
      const welcome = document.getElementById("welcome-text");
      welcome.textContent = `Bem-vindo(a), ${username}`;
    }

    function setRoleBadge() {
      const badge = document.getElementById("role-badge");
      if (!badge) return;

      const storedRole = localStorage.getItem(ROLE_KEY);
      if (storedRole) {
        badge.textContent = storedRole;
        return;
      }

      const token = getToken();
      const roleFromToken = token ? extractRole(parseJwt(token)) : null;
      if (roleFromToken) {
        localStorage.setItem(ROLE_KEY, roleFromToken);
        badge.textContent = roleFromToken;
      } else {
        badge.textContent = "Perfil";
      }
    }

    function getCurrentRole() {
      const storedRole = localStorage.getItem(ROLE_KEY);
      if (storedRole) return storedRole;

      const token = getToken();
      const roleFromToken = token ? extractRole(parseJwt(token)) : null;
      if (roleFromToken) {
        localStorage.setItem(ROLE_KEY, roleFromToken);
      }
      return roleFromToken;
    }

    function isAdmin() {
      const role = getCurrentRole();
      return role && role.toString().toLowerCase() === "admin";
    }

    // ----------------------------
    // Edifícios
    // GET /api/Buildings
    // ----------------------------
    async function loadBuildings() {
      const tbody = document.getElementById("buildings-table-body");
      tbody.innerHTML = `
        <tr>
          <td colspan="4">A carregar...</td>
        </tr>
      `;

      try {
        const buildings = await apiFetch("/api/Buildings");
        buildingsCache = Array.isArray(buildings) ? buildings : [];

        if (!buildingsCache.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="4">Nenhum edifício encontrado.</td>
            </tr>
          `;
          document.getElementById("stat-buildings").textContent = "0";
          return;
        }

        document.getElementById("stat-buildings").textContent =
          buildingsCache.length;

        const rowsHtml = buildingsCache
          .map((b) => {
            const id = b.id;
            const name = b.name || `Edifício #${id}`;
            const address = b.address || "-";
            const risk = b.riskType || "-";

            return `
              <tr>
                <td>${escapeHtml(id)}</td>
                <td>${escapeHtml(name)}</td>
                <td>${escapeHtml(address)}</td>
                <td>${escapeHtml(risk)}</td>
              </tr>
            `;
          })
          .join("");

        tbody.innerHTML = rowsHtml;
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `
          <tr>
            <td colspan="4">Erro ao carregar edifícios: ${escapeHtml(
          err.message
        )}</td>
          </tr>
        `;
        document.getElementById("stat-buildings").textContent = "–";
      }
    }

    // ----------------------------
    // Stats: sensores / alertas / incidentes
    // ----------------------------
    async function loadSensorsStats() {
      try {
        const sensors = await apiFetch("/api/Sensors");
        const count = Array.isArray(sensors) ? sensors.length : "–";
        document.getElementById("stat-sensors").textContent = count;
      } catch (err) {
        console.warn("Erro ao carregar sensores:", err);
        document.getElementById("stat-sensors").textContent = "–";
      }
    }

    async function loadAlertsStats() {
      try {
        const alerts = await apiFetch("/api/Alerts");
        const items = Array.isArray(alerts) ? alerts : [];
        const active = items.filter((a) => a.isResolved === false).length;
        document.getElementById("stat-alerts").textContent =
          active || items.length || "0";
      } catch (err) {
        console.warn("Erro ao carregar alertas:", err);
        document.getElementById("stat-alerts").textContent = "–";
      }
    }

    async function loadIncidentsStats() {
      try {
        const incidents = await apiFetch("/api/Incidents");
        const items = Array.isArray(incidents) ? incidents : [];
        const active = items.filter(
          (i) =>
            (i.status || "").toString().toLowerCase() !== "resolved" ||
            i.endedAt == null
        ).length;
        document.getElementById("stat-incidents").textContent =
          active || items.length || "0";
      } catch (err) {
        console.warn("Erro ao carregar incidentes:", err);
        document.getElementById("stat-incidents").textContent = "–";
      }
    }

    // ----------------------------
    // Leituras de sensores
    // GET /api/SensorReadings
    // ----------------------------
    async function loadLatestReadings(limit = 10) {
      const tbody = document.getElementById("readings-table-body");
      tbody.innerHTML = `
        <tr>
          <td colspan="5">A carregar...</td>
        </tr>
      `;

      try {
        const readings = await apiFetch("/api/SensorReadings");
        const list = Array.isArray(readings) ? readings : [];

        if (!list.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5">Nenhuma leitura encontrada.</td>
            </tr>
          `;
          return;
        }

        const sorted = list
          .slice()
          .sort(
            (a, b) =>
              new Date(b.timestamp || 0) - new Date(a.timestamp || 0)
          )
          .slice(0, limit);

        const rowsHtml = sorted
          .map((r) => {
            const ts = r.timestamp
              ? new Date(r.timestamp).toLocaleString("pt-PT")
              : "-";

            const sensorId =
              (r.sensor && r.sensor.id != null
                ? r.sensor.id
                : r.sensorId != null
                ? r.sensorId
                : null);

            const sensorLabel =
              (r.sensor &&
                (r.sensor.name || `Sensor #${sensorId ?? "?"}`)) ||
              (sensorId != null
                ? `Sensor #${sensorId}`
                : "Sensor");

            const buildingId =
              (r.sensor && r.sensor.buildingId != null
                ? r.sensor.buildingId
                : r.buildingId != null
                ? r.buildingId
                : null);

            const value = r.value != null ? r.value.toString() : "-";

            return `
              <tr>
                <td>${escapeHtml(ts)}</td>
                <td>${escapeHtml(sensorLabel)}</td>
                <td>${escapeHtml(sensorId ?? "-")}</td>
                <td>${escapeHtml(buildingId ?? "-")}</td>
                <td>${escapeHtml(value)}</td>
              </tr>
            `;
          })
          .join("");

        tbody.innerHTML = rowsHtml;
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `
          <tr>
            <td colspan="5">Erro ao carregar leituras: ${escapeHtml(
          err.message
        )}</td>
          </tr>
        `;
      }
    }

    // ----------------------------
    // Alertas (tabela)
    // GET /api/Alerts
    // ----------------------------
    async function loadAlertsTable(limit = 10) {
      const tbody = document.getElementById("alerts-table-body");
      tbody.innerHTML = `
        <tr>
          <td colspan="5">A carregar...</td>
        </tr>
      `;

      try {
        const alerts = await apiFetch("/api/Alerts");
        const list = Array.isArray(alerts) ? alerts : [];

        if (!list.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5">Nenhum alerta encontrado.</td>
            </tr>
          `;
          return;
        }

        const sorted = list
          .slice()
          .sort(
            (a, b) =>
              new Date(b.createdAt || b.timestamp || b.raisedAt || 0) -
              new Date(a.createdAt || a.timestamp || a.raisedAt || 0)
          )
          .slice(0, limit);

        const rowsHtml = sorted
          .map((a) => {
            const ts = a.createdAt || a.timestamp || a.raisedAt;
            const tsText = ts ? new Date(ts).toLocaleString("pt-PT") : "-";

            const type = a.type || a.category || "-";
            const severity = a.severity || a.level || "-";

            let statusText = "-";
            if (typeof a.isResolved === "boolean") {
              statusText = a.isResolved ? "Resolvido" : "Ativo";
            } else if (a.status) {
              statusText = a.status;
            }

            const origin =
              (a.sensor && a.sensor.name) ||
              (a.building && a.building.name) ||
              (a.sensorId != null && `Sensor #${a.sensorId}`) ||
              (a.buildingId != null && `Edifício #${a.buildingId}`) ||
              "-";

            return `
              <tr>
                <td>${escapeHtml(tsText)}</td>
                <td>${escapeHtml(type)}</td>
                <td>${escapeHtml(severity)}</td>
                <td>${escapeHtml(statusText)}</td>
                <td>${escapeHtml(origin)}</td>
              </tr>
            `;
          })
          .join("");

        tbody.innerHTML = rowsHtml;
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `
          <tr>
            <td colspan="5">Erro ao carregar alertas: ${escapeHtml(
          err.message
        )}</td>
          </tr>
        `;
      }
    }


    // ----------------------------
    // Incidentes
    // GET /api/Incidents
    // ----------------------------
    async function loadLatestIncidents(limit = 10) {
      const tbody = document.getElementById("incidents-table-body");
      tbody.innerHTML = `
        <tr>
          <td colspan="5">A carregar...</td>
        </tr>
      `;

      try {
        const incidents = await apiFetch("/api/Incidents");
        const list = Array.isArray(incidents) ? incidents : [];

        if (!list.length) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5">Nenhum incidente encontrado.</td>
            </tr>
          `;
          return;
        }

        const sorted = list
          .slice()
          .sort(
            (a, b) =>
              new Date(b.startedAt || 0) - new Date(a.startedAt || 0)
          )
          .slice(0, limit);

        const rowsHtml = sorted
          .map((i) => {
            const start = i.startedAt
              ? new Date(i.startedAt).toLocaleString("pt-PT")
              : "-";
            const type = i.type || "-";
            const severity = i.severity || "-";
            const status = i.status || "-";

            const buildingName =
              (i.building && i.building.name) ||
              (buildingsCache.find((b) => b.id === i.buildingId) || {})
                .name ||
              (i.buildingId != null
                ? `Edifício #${i.buildingId}`
                : "-");

            return `
              <tr>
                <td>${escapeHtml(start)}</td>
                <td>${escapeHtml(type)}</td>
                <td>${escapeHtml(severity)}</td>
                <td>${escapeHtml(status)}</td>
                <td>${escapeHtml(buildingName)}</td>
              </tr>
            `;
          })
          .join("");

        tbody.innerHTML = rowsHtml;
      } catch (err) {
        console.error(err);
        tbody.innerHTML = `
          <tr>
            <td colspan="5">Erro ao carregar incidentes: ${escapeHtml(
          err.message
        )}</td>
          </tr>
        `;
      }
    }

    // ----------------------------
    // Carregar tudo
    // ----------------------------
    async function loadStats() {
      await loadBuildings();
      await loadSensorsStats();
      await loadAlertsStats();
      await loadIncidentsStats();
      await loadAlertsTable();
      await loadLatestReadings();
      await loadLatestIncidents();
    }

    // ----------------------------
    // Inicialização
    // ----------------------------
    document.addEventListener("DOMContentLoaded", () => {
      if (!ensureAuthenticated()) return;

      setWelcomeMessage();
      loadStats();

      const adminPanels = document.querySelectorAll(".admin-panel");
      if (isAdmin()) {
        adminPanels.forEach((panel) => panel.classList.remove("hidden"));
      }

      // Navegação rápida entre secções
      document.querySelectorAll(".sidebar-nav .nav-link").forEach((link) => {
        link.addEventListener("click", (event) => {
          const targetId = link.getAttribute("href");
          if (!targetId || !targetId.startsWith("#")) return;

          event.preventDefault();
          const target = document.querySelector(targetId);
          if (target) {
            target.scrollIntoView({ behavior: "smooth" });
          }

          document
            .querySelectorAll(".sidebar-nav .nav-link")
            .forEach((l) => l.classList.remove("active"));
          link.classList.add("active");
        });
      });

      document
        .getElementById("reload-buildings")
        .addEventListener("click", () => loadBuildings());

      document
        .getElementById("reload-readings")
        .addEventListener("click", () => loadLatestReadings());

      document
        .getElementById("reload-incidents")
        .addEventListener("click", () => loadLatestIncidents());

      document
        .getElementById("reload-alerts")
        .addEventListener("click", () => loadAlertsTable());

      document
        .getElementById("btn-logout")
        .addEventListener("click", () => {
          localStorage.removeItem(TOKEN_KEY);
          localStorage.removeItem(USERNAME_KEY);
          localStorage.removeItem(ROLE_KEY);
          window.location.href = "login.html";
        });

      const createBuildingForm = document.getElementById("create-building-form");
      if (createBuildingForm) {
        createBuildingForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const status = document.getElementById("create-building-status");
          status.textContent = "A guardar...";
          status.classList.remove("error", "success");

          const name = document.getElementById("building-name").value.trim();
          const address = document
            .getElementById("building-address")
            .value.trim();
          const latitude = parseFloat(
            document.getElementById("building-latitude").value
          );
          const longitude = parseFloat(
            document.getElementById("building-longitude").value
          );
          const riskType = document
            .getElementById("building-risk")
            .value.trim();

          try {
            const body = {
              name,
              address,
              latitude,
              longitude,
              riskType: riskType || "None",
            };

            const created = await apiFetch("/api/Buildings", {
              method: "POST",
              body: JSON.stringify(body),
            });

            if (created) {
              buildingsCache.push(created);
            }

            status.textContent = "Edifício criado com sucesso.";
            status.classList.add("success");
            createBuildingForm.reset();
            await loadBuildings();
          } catch (err) {
            console.error(err);
            status.textContent = err.message || "Erro ao criar edifício.";
            status.classList.add("error");
          }
        });
      }

      const createSensorForm = document.getElementById("create-sensor-form");
      if (createSensorForm) {
        createSensorForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const status = document.getElementById("create-sensor-status");
          status.textContent = "A guardar...";
          status.classList.remove("error", "success");

          const name = document.getElementById("sensor-name").value.trim();
          const type = document.getElementById("sensor-type").value.trim();
          const buildingIdValue = document.getElementById(
            "sensor-building-id"
          ).value;
          const buildingId = buildingIdValue ? Number(buildingIdValue) : null;

          try {
            await apiFetch("/api/Sensors", {
              method: "POST",
              body: JSON.stringify({ name, type, buildingId }),
            });

            status.textContent = "Sensor criado com sucesso.";
            status.classList.add("success");
            createSensorForm.reset();
            await Promise.all([
              loadSensorsStats(),
              loadLatestReadings(),
              loadAlertsTable(),
            ]);
          } catch (err) {
            console.error(err);
            status.textContent = err.message || "Erro ao criar sensor.";
            status.classList.add("error");
          }
        });
      }
    });

  </script>
</body>

</html>